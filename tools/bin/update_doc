#!/bin/bash

################################################################################
# This file allows to automatically update the generated documentation on
# master and the gh-pages branch.
#
# To use it:
#
#   1. Go to a clean master branch
#
#   2. Perform the modifications you want to do on the "doc" directory.
#
#   3. Call this script.
#      Some user interactions will be needed to avoid doing unwanted commits.
#
#   4. That's it!
#      A commit should have been pushed to gh-pages and master.
#
################################################################################

set -e

current_branch=$(git branch | sed -n -e 's/^\* \(.*\)/\1/p')

if ! [ $current_branch == "master" ]; then
  echo $current_branch
  echo "ERROR: The current branch should be master"
  exit 1;
fi

# Generate documentation
npm run doc

# update master
if [ -n "$(git status --porcelain doc)" ]; then
  echo "-- Current Status on master: --"
  echo ""
  git status doc

  REPLY=""
  while ! [[ $REPLY =~ ^[Yy](es)?$ ]]; do
    echo ""
    echo "We will push this to master."
    read -p "Do you want to continue (y/n/d:see the diff): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Nn]o?$ ]]; then
      exit 0
    elif [[ $REPLY =~ ^[Dd](iff)?$ ]]; then
      git diff doc || true # ignore when return 1
    fi
  done

  git add doc
  git commit -m "update documentation" -S
  git push origin master
fi

tmpDir=$(mktemp -d)
cp -r doc/* $tmpDir

# update gh-pages
git checkout gh-pages
git pull origin gh-pages
rm -rf doc
mv $tmpDir/generated doc

if [ -n "$(git status --porcelain doc)" ]; then
  echo "-- Current Status on gh-pages: --"
  echo ""
  git status doc

  REPLY=""
  while ! [[ $REPLY =~ ^[Yy](es)?$ ]]; do
    echo ""
    echo "We will push this to gh-pages."
    read -p "Do you want to continue (y: yes/n: no/d: see the diff): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Nn]o?$ ]]; then
      rm -rf $tmpDir
      git checkout master
      exit 0
    elif [[ $REPLY =~ ^[Dd](iff)?$ ]]; then
      git diff doc || true # ignore when return 1
    fi
  done

  git add doc
  git commit -m "update documentation" -S
  git push origin gh-pages
fi

git checkout master
