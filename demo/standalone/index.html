<!DOCTYPE html>
<html lang="en">
  <head>
    <head>
      <meta charset="UTF-8">
      <title>RxPlayer - CANAL+ (stand-alone demo)</title>
    </head>
    <body>
      <video id="video" width="1600px" height="900px"></video>
      <script type="text/javascript" src="./lib.js" charset="utf-8"></script>
      <script charset="utf-8">
        const preprod_token = "10501u26H1u7fqZd8kP_6PCcHXu6g2UcKzNGkNWV88IUtdOUQHkKZiAHTsNzfmtV35r2ebejK99gpXjX-rhjS37msUK-NCSpeq6vliwGk4BHskbSQSCP-N9qQ8iByNo1A4Jq5uhvxpio4nzqM-yDFSQiH9Q1n3yPJvvFcCDKhjN3wSVjHlROK1R3QBhNuY6QxpeBI944EEWWm5thi_WFpxXTFlKB_XhYx0eG2h84K4o3gmAKQzElsMAQPyDqBYCiJjZjCaqmHxVFCo56KpgRbKyNbhqEnnSLRiumTUG96OSykt4EASLJPV6RIeb_3bJlXPOyUWPD7gY1-w_nbhu7G7Jzv4ni2McQDki7l4P7mmy_63ycukYskpb_lu_uwcW-Um3qtapPO5kPH8a5If4_phUo1lj9_lPsEaAhxweXGfiWGUvNJQ-_M-Y5JW3XRKc_BtgilSaI2qOzvAvEttXL1XF5io2ycUHQfZXqXzvEq1GXAK74Vr3V1dpddhqmNfQlxupK5Lej6asrHvic-xvxpoIVXl3KW9oRNjTHgWpjP5_b-LUgQEddOY52d-53Lt81njLu5dSpvbjxH2pFu4dRdaav2Vf4fRzNtxXJ3MUVzIk4OrNdjgNAB4chXppcmLUsx2_uA64Z9A8wnMzGvTcflhFds0bnvWCRJGAHceSdMZloXzA61WlkEk_T53qk2pjLXRmGMed7MFrESPEWarjnigEJpA_kP_jjNekKfFutjYYzxd4tHqNCGcFBM2mJqz3hd2beH";
        function passInit(callback) {
          const body = document.getElementsByTagName('body')[0];
          const passScript = document.createElement('script');
          passScript.type = 'text/javascript';
          const passCSS = document.createElement('link');
          passCSS.type = 'text/css';
          passCSS.rel = 'stylesheet';
          passCSS.media = 'screen';
          passScript.src = 'https://media-pass.canal-plus.com/latest/js/bundle.js';
          passCSS.href = 'https://media-pass.canal-plus.com/1/css/basic.css';

          passScript.onload = () => {
            try {
              window.waitForPassJSON(() => {
                const passToken = window.getPassToken();
                const { isSubscriber } = window.passJSON;
              });
              callback();
            } catch (e) {
              console.error(e);
            }
          };
          body.appendChild(passScript);
        }

        function download(url, responseType){
          const xhr = new XMLHttpRequest();
          xhr.open("GET",url,true);
          xhr.responseType = responseType;
          xhr.send();
          return new Promise((resolve, reject) => {
            xhr.onload = (evt) => {
              resolve(evt.target.response);
            }
          })
        }

        ///////////////// Parse BXF /////////////////////////////////////////

        // A PARTIR DE MAINTENANT, ASYNCHRONE
        function callback() {
          return download("http://127.0.0.1:8080/family.xml", "text").then((bxfString) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST","http://127.0.0.1:3000/playlist", true);
          xhr.send(bxfString);
          xhr.responseType = "json";
          xhr.onload = (evt) => {
            const parsedBXF = evt.target.response;

            ///////////////////////// GET PLAYSET FROM HAPI ///////////////////////////////

            const mapped = parsedBXF.contents.map((content) => {
              if(content.video[0]){
                const { affaire, pgrm, type } = content.video[0];
                if(type === "CIN"){
                const HAPIUrl = "http://f4w5-partner.canal-plus.io/catalog/unit/ANT_" + affaire + "_" + pgrm;
                const xhr = new XMLHttpRequest();
                xhr.open("GET", HAPIUrl, false);
                xhr.setRequestHeader("xx-operator","pc");
                xhr.setRequestHeader("xx-service","mycanal");
                xhr.setRequestHeader("xx-follow-links","playsets,contents");
                xhr.setRequestHeader("xx-suboffers","RALD_OCS, CP_ALD_SER,CP_ALD");
                xhr.setRequestHeader("xx-domain", "json");
                xhr.send();
                const status = xhr.status;
                if(status <= 300 && 200 <= status){
                  const result = JSON.parse(xhr.response);
                  if(result.playsets){
                    const widevinePlayset = result.playsets.data.reduce((acc, val) => {
                      if(val.drmType === "DRM Widevine"){
                        return val;
                      }
                      return acc;
                    }, undefined);

                    ///////////////// RECUPERER URL MANIFEST + LICENCE ////////////////
                    const _xhr = new XMLHttpRequest();
                    const VIEWUrl = "http://f4w5-partner.canal-plus.io/conso/view";
                    _xhr.open("PUT", VIEWUrl, false);
                    _xhr.setRequestHeader("xx-operator","pc");
                    _xhr.setRequestHeader("authorization", "PASS Token=\""+preprod_token+"\"");
                    _xhr.setRequestHeader("xx-service","mycanal");
                    _xhr.setRequestHeader("xx-follow-links","medias");
                    _xhr.setRequestHeader("xx-distmodes", "tvod,catchup,svod,live,postvod");
                    _xhr.setRequestHeader("xx-suboffers","RALD_OCS, CP_ALD_SER,CP_ALD");
                    _xhr.setRequestHeader("xx-domain", "json");
                    _xhr.setRequestHeader("xx-profile-id","0");
                    _xhr.setRequestHeader("xx-device","pc ebf5f9a1-9a02-461d-8723-abb962396981");
                    _xhr.setRequestHeader("Content-Type","application/json; charset=utf-8");
                    _xhr.send(JSON.stringify(widevinePlayset));
                    const status = _xhr.status;
                    if(status <= 300 && 200 <= status){
                      const result = JSON.parse(_xhr.response);
                      const data = result.medias.data;
                      const licence = result["@licence"];
                      const manifestUrl = data[data.VM ? "VM": "VF"][0].files[0].distribURL;
                      const video = content.video[0];
                      video.url = manifestUrl;
                      video.licenceUrl = licence;
                      content.video[0] = video;
                      return content;
                    }
                  }
                  // NO PLAYSET IN CATALOG UNIT, WE SEARCH IN CONSO/PLAYLIST
                  const id = result.id;
                  const playsetsUrl = "http://f4w5-partner.canal-plus.io/conso/playset?contentId="+id;  
                  const __xhr = new XMLHttpRequest();
                  __xhr.open("GET", playsetsUrl, false);
                  __xhr.setRequestHeader("xx-operator","pc");
                  __xhr.setRequestHeader("authorization", "PASS Token=\""+preprod_token+"\"");
                  __xhr.setRequestHeader("xx-service","mycanal");
                  // xhr.setRequestHeader("xx-follow-links","medias");
                  // xhr.setRequestHeader("xx-distmodes", "tvod,catchup,svod,live,postvod");
                  __xhr.setRequestHeader("xx-suboffers","RALD_OCS, CP_ALD_SER,CP_ALD");
                  __xhr.setRequestHeader("xx-domain", "json");
                  __xhr.setRequestHeader("xx-profile-id","0");
                  __xhr.setRequestHeader("xx-device","pc ebf5f9a1-9a02-461d-8723-abb962396981");
                  __xhr.setRequestHeader("Content-Type","application/json; charset=utf-8");
                  __xhr.send();
                  const status = __xhr.status;
                  if(status <= 300 && 200 <= status){
                      const result = JSON.parse(_xhr.response);
                      const playsets = result.available;
                      const widevinePlayset = playsets.reduce((acc, val) => {
                      if(val.drmType === "DRM Widevine"){
                        return val;
                      }
                      return acc;
                    }, undefined);

                   ///////////////// RECUPERER URL MANIFEST + LICENCE ////////////////
                    const ___xhr = new XMLHttpRequest();
                    const VIEWUrl = "http://f4w5-partner.canal-plus.io/conso/view";
                    ___xhr.open("PUT", VIEWUrl, false);
                    ___xhr.setRequestHeader("xx-operator","pc");
                    ___xhr.setRequestHeader("authorization", "PASS Token=\""+preprod_token+"\"");
                    ___xhr.setRequestHeader("xx-service","mycanal");
                    ___xhr.setRequestHeader("xx-follow-links","medias");
                    ___xhr.setRequestHeader("xx-distmodes", "tvod,catchup,svod,live,postvod");
                    ___xhr.setRequestHeader("xx-suboffers","RALD_OCS, CP_ALD_SER,CP_ALD");
                    ___xhr.setRequestHeader("xx-domain", "json");
                    ___xhr.setRequestHeader("xx-profile-id","0");
                    ___xhr.setRequestHeader("xx-device","pc ebf5f9a1-9a02-461d-8723-abb962396981");
                    ___xhr.setRequestHeader("Content-Type","application/json; charset=utf-8");
                    ___xhr.send(JSON.stringify(widevinePlayset));
                    const status = ___xhr.status;
                    if(status <= 300 && 200 <= status){
                      const result = JSON.parse(___xhr.response);
                      const data = result.medias.data;
                      const licence = result["@licence"];
                      const manifestUrl = data[data.VM ? "VM": "VF"][0].files[0].distribURL;
                      const video = content.video[0];
                      video.url = manifestUrl;
                      video.licenceUrl = licence;
                      content.video[0] = video;
                      return content;
                    }
                  }
                }
                }
              }
              return content;
            });
            const filtered = mapped
              .filter((content) => content.video[0].url)
              .map((data) => {
                const content = data.video[0];
                return {
                  startTime: content.startTime,
                  endTime: content.endTime,
                  url: content.url+"/Manifest",
                  licenceUrl: content.licenceUrl,
                };
              });

            const contents = filtered.reduce((acc, val) => {
              const start = val.startTime;
              const prevEnd = (acc.length > 0) ? acc[acc.length - 1].endTime : ((Date.now() / 1000) - 7200);
              const diff = start - prevEnd;
              const result = {
                url: val.url,
                startTime: val.startTime - diff,
                endTime: val.endTime - diff,
                transport: "smooth",
                licenceUrl: val.licenceUrl,
              };
              acc.push(result);
              return acc;
            }, []);

            const final = { contents : contents };
            ////// JUSTE LE TEMPS DE CREER LE FICHIER ///////
            debugger;

        function bytesToStr(bytes) {
          return String.fromCharCode.apply(null, bytes);
        }

        function getLicense(challenge){
          const xhr = new XMLHttpRequest();
          xhr.open("POST","http://f4w5-partner.canal-plus.io/conso/view/e1ce3870-23a3-11e8-8e11-c1786efc89bd/licence?drmType=DRM%20Widevine", true);
          xhr.setRequestHeader("xx-operator","pc");
          xhr.setRequestHeader("xx-service","mycanal");
          xhr.setRequestHeader("xx-distmodes","catchup,live,svod,tvod,posttvod");
          xhr.setRequestHeader("xx-domain", "json");
          xhr.setRequestHeader("xx-profile-id","0");
          xhr.setRequestHeader("xx-device","pc ebf5f9a1-9a02-461d-8723-abb962396981");
          xhr.setRequestHeader("authorization", "PASS Token=\""+preprod_token+"\"");
          xhr.setRequestHeader("xx-api-version", "2");
          xhr.setRequestHeader("Content-type", "text/plain");
          const formatted = btoa(bytesToStr(challenge));
          xhr.send(formatted);
          return new Promise((resolve, reject) => {
            xhr.onload = (evt) => {
              debugger;
              const licence = evt.target.response;
              resolve(licence);
            }
          })

        }

            player.loadVideo({
              url: "http://127.0.0.1:8080/playlist.meta",
              transport: "metaplaylist",
              autoPlay: true,
              keySystems: [
                {
                  type: "widevine",
                  getLicense,
                }
              ]
            });
          }
        });
        }

        passInit(callback);

        const player = new window.RxPlayer({
          videoElement: document.getElementById("video")
        });

        window.player = player;
      </script>
    </body>

</html>
